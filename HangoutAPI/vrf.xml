<?xml version="1.0" encoding="UTF-8" ?>
<Module>
<!-- Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *      
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License
-->
        <ModulePrefs title="Hangout Starter">
                <Require feature="rpc" />
                <Require feature="views" />\
                <Require feature="locked-domain" /> \
        </ModulePrefs>
        <Content type="html"><![CDATA[     

<html>
<head>
        <title>Virutal Fitting Room</title>
            <meta http-equiv="Content-Type" content="text/html;
charset = iso - 8859 - 1 " />
</head>

<div id = "loadingMessage">Loading your accessories... </div>

<script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script>

function loadOverlay(uri) {
    console.log("loading");
    resource = gapi.hangout.av.effects.createImageResource(
        uri);

    resource.onLoad.add( function(event) {
        if ( !event.isLoaded ) {
            $("#loadingMessage").text("Error occured while loading, please restart this app");
        } else {
            $("#loadingMessage").text("Accessories loaded");
        }
    });
    overlay = resource.createFaceTrackingOverlay(
        {'trackingFeature': gapi.hangout.av.effects.FaceTrackingFeature.NOSE_ROOT,
         'scaleWithFace': true,
         'rotateWithFace': true,
         'scale': 0.5,
         'scaleWithFace' : true});
    overlay.setOffset(-0.12,-1);
    overlay.setVisible(true);
    console.log('loaded');
}

$.fn.textWidth = function(){
  var html_org = $(this).html();
  var html_calc = '<span>' + html_org + '</span>';
  $(this).html(html_calc);
  var width = $(this).find('span:first').width();
  $(this).html(html_org);
  return width;
};


function init() {
  gapi.hangout.onApiReady.add(function(eventObj) {
    var vCanvas = gapi.hangout.layout.getVideoCanvas();
    var wHeight = $(window).height();
    var wWidth = $(window).width();
    console.log(wWidth);
    console.log("offset");
    vCanvas.setVisible(true);
    console.log(vCanvas.getHeight());
    var newSize = vCanvas.setHeight(380);
    var cHeight = newSize["height"];
    var cWidth = newSize["width"];
    console.log("new Size:");
    console.log(cHeight);
    console.log(cWidth);
    console.log($("#loadingMessage").textWidth());
    $("#loadingMessage").offset({top:cHeight+20,left: wWidth/2-($("#loadingMessage").textWidth()/2)});
    console.log($("#loadingMessage").offset());
    vCanvas.setPosition(wWidth/2-(cWidth/2),0);
    loadOverlay("https://dl.dropboxusercontent.com/u/69037120/site/cap2.png");
  });
}

gadgets.util.registerOnLoadHandler(init);
</script>
</html>
]]>

</Content>

</Module>